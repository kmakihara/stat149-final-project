---
title: 'STAT 149: Final Project'
author: "Kazuma Makihara and Bobby Byung-Hoon Min"
date: "4/17/2018"
output: pdf_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r, include=FALSE, echo=FALSE}
#### Set up process here ####
#install.packages("faraway")
#install.packages("nnet")

#install.packages("car")
#install.packages("kyotil")
#install.packages("arm")


```

```{r include=FALSE}
#### Include R Scripts without including in the markdown ####
na.convert.mean = function (frame) 
{
    vars <- names(frame)
    if (!is.null(resp <- attr(attr(frame, "terms"), "response"))) {
        vars <- vars[-resp]
        x <- frame[[resp]]
        pos <- is.na(x)
        if (any(pos)) {
            frame <- frame[!pos, , drop = FALSE]
            warning(paste(sum(pos), "observations omitted due to missing values in the response"))
        }
    }
    for (j in vars) {  #j is variable names
        x <- frame[[j]]
        pos <- is.na(x)
        if (any(pos)) {
            if (length(levels(x))) {   # factors
                xx <- as.character(x)
                xx[pos] <- "NA"
                x <- factor(xx, exclude = NULL)
            }
            else if (is.matrix(x)) {   # matrices
                ats <- attributes(x)
                x.na <- 1*pos
#               x[pos] <- 0
                w <- !pos
                n <- nrow(x)
                TT <- array(1, c(1, n))
                xbar <- (TT %*% x)/(TT %*% w)
                xbar <- t(TT) %*% xbar
                x[pos] <- xbar[pos]
                attributes(x) <- ats
                attributes(x.na) <- ats
                dimnames(x.na)[[2]]=paste(dimnames(x)[[2]],".na",sep='')
                frame[[paste(j,".na",sep='')]] <- x.na 
            } else {   # ordinary numerical vector
                ats <- attributes(x)
                x[pos] <- mean(x[!pos])
#               x[pos] <- 0
                x.na <- 1*pos
                frame[[paste(j,".na",sep='')]] <- x.na 
                attributes(x) <- ats
            }
            frame[[j]] <- x
        }
    }
    frame
}
```

## Title
### Sub-Title
Write-up paragraphs and \alpha sign and shit.
```{r, out.width = "500px"}
#### Images are included by doing this #####
knitr::include_graphics("./pset4_q1.jpg")
```

```{r}
# OUR FIRST ATTEMPTS AT UNDERSTANDING DATASET
#Run summary statistics on the train data and, then, fit the full dataset with all predictors to a basic glm model.
summary(train)
head(train)
train$suppdem = as.numeric(train$suppdem) - 1
# Missing Value Mean Imputer
train.na = na.convert.mean(train)
full <- glm(suppdem ~ ., family = binomial, data = train.na)
summary(full)
preds = predict(full, data=train.na, type="response")
logLoss(train.na$suppdem, preds)
```

## Introduction and Setup
### Download Packages & Load Dataset
```{r}
#library(brglm)
#library(aod)
#library(faraway)
#library(nnet)
#library(arm)
#library(Metrics)
train <- read.csv("./Data/train.csv")
test <- read.csv("./Data/test.csv")
```
### Split Train into Train and Validate
```{r}
set.seed(149) 
# 70% of train as myrtrain and 30% as myvalidate
sample <- sample.int(n = nrow(train), size = floor(.70*nrow(train)), replace = F)
mytrain <- train[sample, ]
myvalidate  <- train[-sample, ]
```
## Explantory Data Analysis (EDA)
### Predictior Variables
Analysis on each predictors to come later
```{r}
names(mytrain)
```

### Summary Statistics
get rid of one of 'density_rural', 'density_suburban', or 'density_urban' -> sums to 1
Change education to ordinal layers and not categorical values? OR change base-line to "no hs degree"
```{r}
summary(mytrain)
```
### Conversion of Indepdent Variable
```{r}
mytrain$suppdem = as.numeric(mytrain$suppdem) - 1
myvalidate$suppdem = as.numeric(myvalidate$suppdem) - 1
```
### Conversion of Education
```{r}
levels(mytrain$education) <- c(levels(mytrain$education), "none")
mytrain$education[is.na(mytrain$education)] <- "none"
levels(myvalidate$education) <- c(levels(myvalidate$education), "none")
myvalidate$education[is.na(myvalidate$education)] <- "none"
levels(test$education) <- c(levels(test$education), "none")
test$education[is.na(test$education)] <- "none"
```

## Model Selection
Step-wise deviance on basic logistic model (binomial fam)
```{r}
stepwise_deviance_selector(mytrain, c(1))
stepwise_deviance_selector(mytrain, c("combined_ethnicity_4way"))
stepwise_deviance_selector(mytrain, c("combined_ethnicity_4way", "density_rural"))
stepwise_deviance_selector(mytrain, c("combined_ethnicity_4way", "density_rural", "sex"))
stepwise_deviance_selector(mytrain, c("combined_ethnicity_4way", "density_rural", "sex", "interest_in_religion"))
stepwise_deviance_selector(mytrain, c("combined_ethnicity_4way", "density_rural", "sex", "interest_in_religion", "liberal_donor"))
stepwise_deviance_selector(mytrain, c("combined_ethnicity_4way", "density_rural", "sex", "interest_in_religion", "liberal_donor", "guns_1"))
stepwise_deviance_selector(within(mytrain, rm("density_urban")), c("combined_ethnicity_4way", "density_rural", "sex", "interest_in_religion", "liberal_donor", "guns_1", "density_suburban"))
stepwise_deviance_selector(within(mytrain, rm("density_urban")), c("combined_ethnicity_4way", "density_rural", "sex", "interest_in_religion", "liberal_donor", "guns_1", "density_suburban", "conservative_donor"))
mytrain.na = na.convert.mean(mytrain)
midpoint_model= glm(formula = suppdem ~ combined_ethnicity_4way + density_rural + sex + interest_in_religion + liberal_donor + guns_1 + density_suburban + conservative_donor + cnty_pct_evangelical + cnty_pct_evangelical.na,
            family = binomial, data = mytrain.na)
preds = predict(midpoint_model, data=mytrain.na, type="response")
logLoss(mytrain.na$suppdem, preds)

# Midpoint model on test data
myval.na = na.convert.mean(myvalidate)
predsval = predict(midpoint_model, data=myval.na, type="response")
logLoss(myval.na$suppdem, predsval)

test.na = na.convert.mean(test)
testpreds = predict(midpoint_model, newdata=test.na, type="response")
testpreds = setNames(data.frame(testpreds), c("suppdem"))
write.csv(testpreds, "./midpoint_model_test.csv")
```

```{r}
stepwise_deviance_selector = function (mytrain, selected_predictors) 
{
  model0 = glm(formula = paste("suppdem ~ ", do.call(paste, c(as.list(selected_predictors), sep = " + "))),
            family = binomial, data = mytrain)
  pval = 0.05
  varname = ""
  missing = FALSE
  for (var in names(mytrain)){
    if (var == "suppdem" | var %in% selected_predictors) next
    if(anyNA(mytrain[[var]])) {
      mytrain.na = na.convert.mean(mytrain)
      na.var = paste(var, ".na", sep="")
      selected = c(var, na.var, selected_predictors)
      model = glm(formula = paste("suppdem ~ ", do.call(paste, c(as.list(selected), sep = " + "))),
                  family = binomial, data = mytrain.na)
      if (anova(model0, model, test="Chisq")$`Pr(>Chi)`[2] < pval){
        varname = var
        pval = anova(model0, model, test="Chisq")$`Pr(>Chi)`[2]
        missing = TRUE
      }
    }
    else{
      selected = c(var, selected_predictors)
      model = glm(formula = paste("suppdem ~ ", do.call(paste, c(as.list(selected), sep = " + ")))
                  , family = binomial, data = mytrain)
      if (anova(model0, model, test="Chisq")$`Pr(>Chi)`[2] < pval){
        varname = var
        pval = anova(model0, model, test="Chisq")$`Pr(>Chi)`[2]
        missing = FALSE
      }
    }
  }
  return(c(varname, missing, pval))
}
```
### Testing
### Step-wise Deviance
### Fitting various models
### Data Imputer


## Predictions
### Results and Conclusions
### Log-loss 