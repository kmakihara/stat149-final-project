---
title: 'STAT 149: Final Project'
author: "Kazuma Makihara and Bobby Byung-Hoon Min"
date: "4/17/2018"
output: pdf_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#### Set-Up
```{r, include=FALSE, echo=FALSE}
#### Set up process here ####
#install.packages("faraway")
#install.packages("nnet")

#install.packages("car")
#install.packages("kyotil")
#install.packages("arm")


```

#### na.convert.mean from lecture notes
```{r include=FALSE}
#### Include R Scripts without including in the markdown ####
na.convert.mean = function (frame) 
{
    vars <- names(frame)
    if (!is.null(resp <- attr(attr(frame, "terms"), "response"))) {
        vars <- vars[-resp]
        x <- frame[[resp]]
        pos <- is.na(x)
        if (any(pos)) {
            frame <- frame[!pos, , drop = FALSE]
            warning(paste(sum(pos), "observations omitted due to missing values in the response"))
        }
    }
    for (j in vars) {  #j is variable names
        x <- frame[[j]]
        pos <- is.na(x)
        if (any(pos)) {
            if (length(levels(x))) {   # factors
                xx <- as.character(x)
                xx[pos] <- "NA"
                x <- factor(xx, exclude = NULL)
            }
            else if (is.matrix(x)) {   # matrices
                ats <- attributes(x)
                x.na <- 1*pos
#               x[pos] <- 0
                w <- !pos
                n <- nrow(x)
                TT <- array(1, c(1, n))
                xbar <- (TT %*% x)/(TT %*% w)
                xbar <- t(TT) %*% xbar
                x[pos] <- xbar[pos]
                attributes(x) <- ats
                attributes(x.na) <- ats
                dimnames(x.na)[[2]]=paste(dimnames(x)[[2]],".na",sep='')
                frame[[paste(j,".na",sep='')]] <- x.na 
            } else {   # ordinary numerical vector
                ats <- attributes(x)
                x[pos] <- mean(x[!pos])
#               x[pos] <- 0
                x.na <- 1*pos
                frame[[paste(j,".na",sep='')]] <- x.na 
                attributes(x) <- ats
            }
            frame[[j]] <- x
        }
    }
    frame
}
```

#### stepwise_deviance_selector takes in a mytrain and a list of already selected_predictors 
```{r}
stepwise_deviance_selector = function (mytrain, selected_predictors, log=FALSE, alpha = 0.05) 
{
  model0 = glm(formula = paste("suppdem ~ ", do.call(paste, c(as.list(selected_predictors), sep = " + "))),
            family = binomial, data = mytrain)
  pval = alpha
  varname = ""
  missing = FALSE
  na.indicator = FALSE
  if (log == TRUE){
    mytrain$census_median_income = log(mytrain$census_median_income)
  }
  for (var in names(mytrain)){
    if (var == "suppdem" | var %in% selected_predictors) next
    if(anyNA(mytrain[[var]])) {
      na.var = paste(var, ".na", sep="")
      selected = c(var, selected_predictors)
      selected.na = c(var, na.var, selected_predictors)
      if (log == TRUE){
        mytrain.log.na <- mytrain.na
        mytrain.log.na$census_median_income = log(mytrain.log.na$census_median_income)
        mytrain.log.na$ppi = log(mytrain.log.na$ppi)
        model = glm(formula = paste("suppdem ~ ", do.call(paste, c(as.list(selected), sep = " + "))),
                    family = binomial, data = mytrain.log.na)
        modelna.na = glm(formula = paste("suppdem ~ ", do.call(paste, c(as.list(selected.na), sep = " + "))),
                    family = binomial, data = mytrain.log.na)
        if (anova(model, modelna.na, test="Chisq")$`Pr(>Chi)`[2] < 0.05) {
          model = modelna.na
          na.indicator = TRUE
        }
        if (anova(model0, model, test="Chisq")$`Pr(>Chi)`[2] < pval){
          varname = var
          pval = anova(model0, model, test="Chisq")$`Pr(>Chi)`[2]
          missing = TRUE
        }
      }
      else{
        mytrain.na = na.convert.mean(mytrain)
        model = glm(formula = paste("suppdem ~ ", do.call(paste, c(as.list(selected), sep = " + "))),
                    family = binomial, data = mytrain.na)
        modelna.na = glm(formula = paste("suppdem ~ ", do.call(paste, c(as.list(selected.na), sep = " + "))),
                    family = binomial, data = mytrain.na)
        if (anova(model, modelna.na, test="Chisq")$`Pr(>Chi)`[2] < 0.05) {
          model = modelna.na
          na.indicator = TRUE
        }
        if (anova(model0, model, test="Chisq")$`Pr(>Chi)`[2] < pval){
          varname = var
          pval = anova(model0, model, test="Chisq")$`Pr(>Chi)`[2]
          missing = TRUE
        }
      }
      
    }
    else{
      selected = c(var, selected_predictors)
      model = glm(formula = paste("suppdem ~ ", do.call(paste, c(as.list(selected), sep = " + ")))
                  , family = binomial, data = mytrain)
      if (anova(model0, model, test="Chisq")$`Pr(>Chi)`[2] < pval){
        varname = var
        pval = anova(model0, model, test="Chisq")$`Pr(>Chi)`[2]
        missing = FALSE
      }
    }
  }
  return(c(varname, missing, pval, na.indicator))
}
```
#### interaction selector
```{r}
interaction_deviance_selector = function (mytrain, selected_predictors, cat_predictors, num_predictors, alpha = 0.05) 
{
  model0 = glm(formula = paste("suppdem ~ ", do.call(paste, c(as.list(selected_predictors), sep = " + "))),
            family = binomial, data = mytrain)
  pval = alpha
  varname = ""
  all_interactions = c()
  for (cat_var in cat_predictors){
    for (num_var in num_predictors){
      int_var = paste(cat_var, num_var, sep=":")
      if (int_var %in% selected_predictors) next
      preds = c(selected_predictors, int_var)
      model = glm(formula = paste("suppdem ~ ", do.call(paste, c(as.list(preds), sep = " + "))),
            family = binomial, data = mytrain)
      if (anova(model0, model, test="Chisq")$`Pr(>Chi)`[2] < pval){
        varname = int_var
        pval = anova(model0, model, test="Chisq")$`Pr(>Chi)`[2]
      }
    }
  }
  return(c(varname, pval))
}
```


## Introduction and Setup
### Download Packages & Load Dataset
```{r}
#library(brglm)
#library(aod)
#library(nnet)
#library(arm)
#library(faraway)
#library(Metrics)
train <- read.csv("./Data/train.csv")
test <- read.csv("./Data/test.csv")
```
### Split Train into Train and Validate
```{r}
set.seed(149) 
# 70% of train as myrtrain and 30% as myvalidate
sample <- sample.int(n = nrow(train), size = floor(.70*nrow(train)), replace = F)
mytrain <- train[sample, ]
myvalidate  <- train[-sample, ]
```
## Explantory Data Analysis (EDA)
### Predictior Variables
Analysis on each predictors to come later
```{r}
names(mytrain)
```

### Summary Statistics
get rid of one of 'density_rural', 'density_suburban', or 'density_urban' -> sums to 1
Change education to ordinal layers and not categorical values? OR change base-line to "no hs degree"
```{r}
summary(mytrain)
```
### Conversion of Indepdent Variable
```{r}
mytrain$suppdem = as.numeric(mytrain$suppdem) - 1
myvalidate$suppdem = as.numeric(myvalidate$suppdem) - 1
```
### Conversion of Education
```{r}
levels(mytrain$education) <- c(levels(mytrain$education), "none")
mytrain$education[is.na(mytrain$education)] <- "none"
levels(myvalidate$education) <- c(levels(myvalidate$education), "none")
myvalidate$education[is.na(myvalidate$education)] <- "none"
levels(test$education) <- c(levels(test$education), "none")
test$education[is.na(test$education)] <- "none"
```

## Model Selection
### Step-wise deviance on basic logistic model (binomial fam)
```{r}
mytrain.na = na.convert.mean(mytrain)
looptrain = within(mytrain.na, rm("density_urban"))
predictors = c(1)
while (stepwise_deviance_selector(looptrain, predictors)[1] != "")
{
  step = stepwise_deviance_selector(looptrain, predictors)
  predictors = c(predictors, step[1])
  # if selected column has NA
  if (step[2]){
    if (step[4]){
        predictors = c(predictors, paste(step[1], ".na", sep=""))
    }
  }
}
print(predictors)
predictors_nointeractions = predictors
```
### Comparison of Stepwise Models
```{r}
model00 = glm(formula = suppdem ~ 1, family = binomial, data = mytrain)
model01 = glm(formula = suppdem ~ combined_ethnicity_4way, family = binomial, data = mytrain)
model02 = glm(formula = suppdem ~ combined_ethnicity_4way + density_rural, family = binomial, data = mytrain)
model03 = glm(formula = suppdem ~ combined_ethnicity_4way + density_rural + sex, family = binomial, data = mytrain)
model04 = glm(formula = suppdem ~ combined_ethnicity_4way + density_rural + sex + interest_in_religion, family = binomial, data = mytrain)
model05 = glm(formula = suppdem ~ combined_ethnicity_4way + density_rural + sex + interest_in_religion + liberal_donor, family = binomial, data = mytrain)
model06 = glm(formula = suppdem ~ combined_ethnicity_4way + density_rural + sex + interest_in_religion + liberal_donor + guns_1, family = binomial, data = mytrain)
model07 = glm(formula = suppdem ~ combined_ethnicity_4way + density_rural + sex + interest_in_religion + liberal_donor + guns_1 + density_suburban, family = binomial, data = within(mytrain, rm("density_urban")))
model08 = glm(formula = suppdem ~ combined_ethnicity_4way + density_rural + sex + interest_in_religion + liberal_donor + guns_1 + density_suburban + conservative_donor, family = binomial, data = within(mytrain, rm("density_urban")))
model09 = glm(formula = suppdem ~ combined_ethnicity_4way + density_rural + sex + interest_in_religion + liberal_donor + guns_1 + density_suburban + conservative_donor + cnty_pct_evangelical, family = binomial, data = within(mytrain.na, rm("density_urban")))
model10 = glm(formula = suppdem ~ combined_ethnicity_4way + density_rural + sex + interest_in_religion + liberal_donor + guns_1 + density_suburban + conservative_donor + cnty_pct_evangelical + contbrel_1, family = binomial, data = within(mytrain.na, rm("density_urban")))
model11 = glm(formula = suppdem ~ combined_ethnicity_4way + density_rural + sex + interest_in_religion + liberal_donor + guns_1 + density_suburban + conservative_donor + cnty_pct_evangelical + contbrel_1 + single, family = binomial, data = within(mytrain.na, rm("density_urban")))
model12 = glm(formula = suppdem ~ combined_ethnicity_4way + density_rural + sex + interest_in_religion + liberal_donor + guns_1 + density_suburban + conservative_donor + cnty_pct_evangelical + contbrel_1 + single + apparel_1, family = binomial, data = within(mytrain.na, rm("density_urban")))
model13 = glm(formula = suppdem ~ combined_ethnicity_4way + density_rural + sex + interest_in_religion + liberal_donor + guns_1 + density_suburban + conservative_donor + cnty_pct_evangelical + contbrel_1 + single + apparel_1 + education, family = binomial, data = within(mytrain.na, rm("density_urban")))
model14 = glm(formula = suppdem ~ combined_ethnicity_4way + density_rural + sex + interest_in_religion + liberal_donor + guns_1 + density_suburban + conservative_donor + cnty_pct_evangelical + contbrel_1 + single + apparel_1 + education + cat_1, family = binomial, data = within(mytrain.na, rm("density_urban")))
model15 = glm(formula = suppdem ~ combined_ethnicity_4way + density_rural + sex + interest_in_religion + liberal_donor + guns_1 + density_suburban + conservative_donor + cnty_pct_evangelical + contbrel_1 + single + apparel_1 + education + cat_1 + num_children, family = binomial, data = within(mytrain.na, rm("density_urban")))
anova(model00, model01, model02, model03, model04, model05, model06, model07, model08, model09, model10, model11, model12, model13, model14, model15, test="Chisq")
```
### Selected Model Prediction
```{r}
preds = predict(model15, data = mytrain.na, type="response")
logLoss(mytrain.na$suppdem, preds)

test.na = na.convert.mean(test)
testpreds = predict(model15, newdata=test.na, type="response")
testpreds = setNames(data.frame(testpreds), c("suppdem"))
write.csv(testpreds, "./model15_test.csv")
```
### Repeat above, but log median income
```{r}
mytrain.loginc.na <- mytrain.na
mytrain.loginc.na$census_median_income = log(mytrain.loginc.na$census_median_income)
mytrain.loginc.na$ppi = log(mytrain.loginc.na$ppi)

looptrain = within(mytrain.loginc.na, rm("density_urban"))
predictors = c(1)
while (stepwise_deviance_selector(looptrain, predictors, log = TRUE)[1] != "")
{
  step = stepwise_deviance_selector(looptrain, predictors, log = TRUE)
  predictors = c(predictors, step[1])
  # if selected column has NA
  if (step[2]){
    if (step[4]){
        predictors = c(predictors, paste(step[1], ".na", sep=""))
    }
  }
}
print(predictors)
```

### Testing out some interactions
```{r}
model32 = glm(formula = suppdem ~ combined_ethnicity_4way + density_rural + sex + interest_in_religion + liberal_donor + guns_1 + density_suburban + conservative_donor + cnty_pct_evangelical + contbrel_1 + single + apparel_1 + education + cat_1 + num_children + education:log(census_median_income), family = binomial, data = within(mytrain.loginc.na, rm("density_urban")))
anova(model15, model32, test="Chisq")
```
### While-loop for Interactions
```{r}
looptrain = within(mytrain.loginc.na, rm("density_urban"))
categorical = c("combined_ethnicity_4way", "density_rural", "sex", "interest_in_religion", "liberal_donor", "guns_1", "density_suburban", "conservative_donor", "cnty_pct_evangelical", "contbrel_1", "single", "apparel_1", "education", "cat_1")
numerical = c("num_children", "age", "census_median_income", "ppi")
predictors = predictors_nointeractions
while (interaction_deviance_selector(looptrain, predictors, categorical, numerical)[1] != "")
{
  step = interaction_deviance_selector(looptrain, predictors, categorical, numerical)
  predictors = c(predictors, step[1])
}
print(predictors)
predictors_interactions = predictors
```
### Selected Model w/ Interaction Prediction
```{r}
model_interaction = glm(formula = paste("suppdem ~ ", do.call(paste, c(as.list(predictors_interactions), sep = " + "))),
            family = binomial, data = looptrain)

test.logna = na.convert.mean(test)
test.logna$census_median_income = log(test.logna$census_median_income)
test.logna$ppi = log(test.logna$ppi)

testpreds = predict(model15, newdata=test.logna, type="response")
testpreds = setNames(data.frame(testpreds), c("suppdem"))
write.csv(testpreds, "./model_interaction_test.csv")
```

### Step-wise deviance with higher alpha


### Step-wise deviance on basic probit & logit model (binomial fam)
 Perhaps we should improve our stepwise_deviance_selector to do the loop exhaustively until it reaches insignificance

### Testing
### Step-wise Deviance
### Fitting various models
### Data Imputer


## Predictions
### Results and Conclusions
### Log-loss 



### MIDPOINT STUFF: REMOVE THIS CHUNK
```{r}
stepwise_deviance_selector(within(mytrain, rm("density_urban")), c("combined_ethnicity_4way", "density_rural", "sex", "interest_in_religion", "liberal_donor", "guns_1", "density_suburban", "conservative_donor", "cnty_pct_evangelical"))


midpoint_model= glm(formula = suppdem ~ combined_ethnicity_4way + density_rural + sex + interest_in_religion + liberal_donor + guns_1 + density_suburban + conservative_donor + cnty_pct_evangelical + cnty_pct_evangelical.na,
            family = binomial, data = mytrain.na)
preds = predict(midpoint_model, data=mytrain.na, type="response")
logLoss(mytrain.na$suppdem, preds)

# Midpoint model on test data
myval.na = na.convert.mean(myvalidate)
predsval = predict(midpoint_model, data=myval.na, type="response")
logLoss(myval.na$suppdem, predsval)

test.na = na.convert.mean(test)
testpreds = predict(midpoint_model, newdata=test.na, type="response")
testpreds = setNames(data.frame(testpreds), c("suppdem"))
write.csv(testpreds, "./midpoint_model_test.csv")
```