---
title: 'STAT 149: Final Project'
author: "Kazuma Makihara and Bobby Byung-Hoon Min"
date: "4/17/2018"
output: pdf_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#### Set-Up
```{r, include=FALSE, echo=FALSE}
#### Set up process here ####
#install.packages("faraway")
#install.packages("nnet")

#install.packages("car")
#install.packages("kyotil")
#install.packages("arm")


```

#### na.convert.mean from lecture notes
```{r include=FALSE}
#### Include R Scripts without including in the markdown ####
na.convert.mean = function (frame) 
{
    vars <- names(frame)
    if (!is.null(resp <- attr(attr(frame, "terms"), "response"))) {
        vars <- vars[-resp]
        x <- frame[[resp]]
        pos <- is.na(x)
        if (any(pos)) {
            frame <- frame[!pos, , drop = FALSE]
            warning(paste(sum(pos), "observations omitted due to missing values in the response"))
        }
    }
    for (j in vars) {  #j is variable names
        x <- frame[[j]]
        pos <- is.na(x)
        if (any(pos)) {
            if (length(levels(x))) {   # factors
                xx <- as.character(x)
                xx[pos] <- "NA"
                x <- factor(xx, exclude = NULL)
            }
            else if (is.matrix(x)) {   # matrices
                ats <- attributes(x)
                x.na <- 1*pos
#               x[pos] <- 0
                w <- !pos
                n <- nrow(x)
                TT <- array(1, c(1, n))
                xbar <- (TT %*% x)/(TT %*% w)
                xbar <- t(TT) %*% xbar
                x[pos] <- xbar[pos]
                attributes(x) <- ats
                attributes(x.na) <- ats
                dimnames(x.na)[[2]]=paste(dimnames(x)[[2]],".na",sep='')
                frame[[paste(j,".na",sep='')]] <- x.na 
            } else {   # ordinary numerical vector
                ats <- attributes(x)
                x[pos] <- mean(x[!pos])
#               x[pos] <- 0
                x.na <- 1*pos
                frame[[paste(j,".na",sep='')]] <- x.na 
                attributes(x) <- ats
            }
            frame[[j]] <- x
        }
    }
    frame
}
```

#### stepwise_deviance_selector takes in a mytrain and a list of already selected_predictors 
```{r}
stepwise_deviance_selector = function (mytrain, selected_predictors, log=FALSE, alpha = 0.05) 
{
  model0 = glm(formula = paste("suppdem ~ ", do.call(paste, c(as.list(selected_predictors), sep = " + "))),
            family = binomial, data = mytrain)
  pval = alpha
  varname = ""
  missing = FALSE
  if (log == TRUE){
    mytrain$census_median_income = log(mytrain$census_median_income)
  }
  for (var in names(mytrain)){
    if (var == "suppdem" | var %in% selected_predictors) next
    if(anyNA(mytrain[[var]])) {
      na.var = paste(var, ".na", sep="")
      selected = c(var, na.var, selected_predictors)
      if (log == TRUE){
        mytrain.log.na <- mytrain.na
        mytrain.log.na$census_median_income = log(mytrain.log.na$census_median_income)
        model = glm(formula = paste("suppdem ~ ", do.call(paste, c(as.list(selected), sep = " + "))),
                    family = binomial, data = mytrain.log.na)
        if (anova(model0, model, test="Chisq")$`Pr(>Chi)`[2] < pval){
          varname = var
          pval = anova(model0, model, test="Chisq")$`Pr(>Chi)`[2]
          missing = TRUE
        }
      }
      else{
        mytrain.na = na.convert.mean(mytrain)
        model = glm(formula = paste("suppdem ~ ", do.call(paste, c(as.list(selected), sep = " + "))),
                    family = binomial, data = mytrain.na)
        if (anova(model0, model, test="Chisq")$`Pr(>Chi)`[2] < pval){
          varname = var
          pval = anova(model0, model, test="Chisq")$`Pr(>Chi)`[2]
          missing = TRUE
        }
      }
      
    }
    else{
      selected = c(var, selected_predictors)
      model = glm(formula = paste("suppdem ~ ", do.call(paste, c(as.list(selected), sep = " + ")))
                  , family = binomial, data = mytrain)
      if (anova(model0, model, test="Chisq")$`Pr(>Chi)`[2] < pval){
        varname = var
        pval = anova(model0, model, test="Chisq")$`Pr(>Chi)`[2]
        missing = FALSE
      }
    }
  }
  return(c(varname, missing, pval))
}
```

## Title
### Sub-Title
Write-up paragraphs and \alpha sign and shit.
```{r, out.width = "500px"}
#### Images are included by doing this #####
knitr::include_graphics("./pset4_q1.jpg")
```

```{r}
# OUR FIRST ATTEMPTS AT UNDERSTANDING DATASET
#Run summary statistics on the train data and, then, fit the full dataset with all predictors to a basic glm model.
summary(train)
head(train)
train$suppdem = as.numeric(train$suppdem) - 1
# Missing Value Mean Imputer
train.na = na.convert.mean(train)
full <- glm(suppdem ~ ., family = binomial, data = train.na)
summary(full)
preds = predict(full, data=train.na, type="response")
logLoss(train.na$suppdem, preds)
```

## Introduction and Setup
### Download Packages & Load Dataset
```{r}
#library(brglm)
#library(aod)
#library(nnet)
#library(arm)
#library(faraway)
#library(Metrics)
train <- read.csv("./Data/train.csv")
test <- read.csv("./Data/test.csv")
```
### Split Train into Train and Validate
```{r}
set.seed(149) 
# 70% of train as myrtrain and 30% as myvalidate
sample <- sample.int(n = nrow(train), size = floor(.70*nrow(train)), replace = F)
mytrain <- train[sample, ]
myvalidate  <- train[-sample, ]
```
## Explantory Data Analysis (EDA)
### Predictior Variables
Analysis on each predictors to come later
```{r}
names(mytrain)
```

### Summary Statistics
get rid of one of 'density_rural', 'density_suburban', or 'density_urban' -> sums to 1
Change education to ordinal layers and not categorical values? OR change base-line to "no hs degree"
```{r}
summary(mytrain)
```
### Conversion of Indepdent Variable
```{r}
mytrain$suppdem = as.numeric(mytrain$suppdem) - 1
myvalidate$suppdem = as.numeric(myvalidate$suppdem) - 1
```
### Conversion of Education
```{r}
levels(mytrain$education) <- c(levels(mytrain$education), "none")
mytrain$education[is.na(mytrain$education)] <- "none"
levels(myvalidate$education) <- c(levels(myvalidate$education), "none")
myvalidate$education[is.na(myvalidate$education)] <- "none"
levels(test$education) <- c(levels(test$education), "none")
test$education[is.na(test$education)] <- "none"
```

## Model Selection
### Step-wise deviance on basic logistic model (binomial fam)
```{r}
model00 = glm(formula = suppdem ~ 1, family = binomial, data = mytrain)
stepwise_deviance_selector(mytrain, c(1))
model01 = glm(formula = suppdem ~ combined_ethnicity_4way, family = binomial, data = mytrain)
stepwise_deviance_selector(mytrain, c("combined_ethnicity_4way"))
model02 = glm(formula = suppdem ~ combined_ethnicity_4way + density_rural, family = binomial, data = mytrain)
stepwise_deviance_selector(mytrain, c("combined_ethnicity_4way", "density_rural"))
model03 = glm(formula = suppdem ~ combined_ethnicity_4way + density_rural + sex, family = binomial, data = mytrain)
stepwise_deviance_selector(mytrain, c("combined_ethnicity_4way", "density_rural", "sex"))
model04 = glm(formula = suppdem ~ combined_ethnicity_4way + density_rural + sex + interest_in_religion, family = binomial, data = mytrain)
stepwise_deviance_selector(mytrain, c("combined_ethnicity_4way", "density_rural", "sex", "interest_in_religion"))
model05 = glm(formula = suppdem ~ combined_ethnicity_4way + density_rural + sex + interest_in_religion + liberal_donor, family = binomial, data = mytrain)
stepwise_deviance_selector(mytrain, c("combined_ethnicity_4way", "density_rural", "sex", "interest_in_religion", "liberal_donor"))
model06 = glm(formula = suppdem ~ combined_ethnicity_4way + density_rural + sex + interest_in_religion + liberal_donor + guns_1, family = binomial, data = mytrain)
stepwise_deviance_selector(mytrain, c("combined_ethnicity_4way", "density_rural", "sex", "interest_in_religion", "liberal_donor", "guns_1"))
model07 = glm(formula = suppdem ~ combined_ethnicity_4way + density_rural + sex + interest_in_religion + liberal_donor + guns_1 + density_suburban, family = binomial, data = within(mytrain, rm("density_urban")))
stepwise_deviance_selector(within(mytrain, rm("density_urban")), c("combined_ethnicity_4way", "density_rural", "sex", "interest_in_religion", "liberal_donor", "guns_1", "density_suburban"))
model08 = glm(formula = suppdem ~ combined_ethnicity_4way + density_rural + sex + interest_in_religion + liberal_donor + guns_1 + density_suburban + conservative_donor, family = binomial, data = within(mytrain, rm("density_urban")))
stepwise_deviance_selector(within(mytrain, rm("density_urban")), c("combined_ethnicity_4way", "density_rural", "sex", "interest_in_religion", "liberal_donor", "guns_1", "density_suburban", "conservative_donor"))
mytrain.na = na.convert.mean(mytrain)
model09.1 = glm(formula = suppdem ~ combined_ethnicity_4way + density_rural + sex + interest_in_religion + liberal_donor + guns_1 + density_suburban + conservative_donor + cnty_pct_evangelical, family = binomial, data = within(mytrain.na, rm("density_urban")))
model09.2 = glm(formula = suppdem ~ combined_ethnicity_4way + density_rural + sex + interest_in_religion + liberal_donor + guns_1 + density_suburban + conservative_donor + cnty_pct_evangelical + cnty_pct_evangelical.na, family = binomial, data = within(mytrain.na, rm("density_urban")))
anova(model09.1, model09.2, test="Chisq")
stepwise_deviance_selector(within(mytrain.na, rm("density_urban")), c("combined_ethnicity_4way", "density_rural", "sex", "interest_in_religion", "liberal_donor", "guns_1", "density_suburban", "conservative_donor", "cnty_pct_evangelical"))
model10 = glm(formula = suppdem ~ combined_ethnicity_4way + density_rural + sex + interest_in_religion + liberal_donor + guns_1 + density_suburban + conservative_donor + cnty_pct_evangelical + contbrel_1, family = binomial, data = within(mytrain.na, rm("density_urban")))
stepwise_deviance_selector(within(mytrain.na, rm("density_urban")), c("combined_ethnicity_4way", "density_rural", "sex", "interest_in_religion", "liberal_donor", "guns_1", "density_suburban", "conservative_donor", "cnty_pct_evangelical", "contbrel_1"))
model11 = glm(formula = suppdem ~ combined_ethnicity_4way + density_rural + sex + interest_in_religion + liberal_donor + guns_1 + density_suburban + conservative_donor + cnty_pct_evangelical + contbrel_1 + single, family = binomial, data = within(mytrain.na, rm("density_urban")))
stepwise_deviance_selector(within(mytrain.na, rm("density_urban")), c("combined_ethnicity_4way", "density_rural", "sex", "interest_in_religion", "liberal_donor", "guns_1", "density_suburban", "conservative_donor", "cnty_pct_evangelical", "contbrel_1", "single"))
model12 = glm(formula = suppdem ~ combined_ethnicity_4way + density_rural + sex + interest_in_religion + liberal_donor + guns_1 + density_suburban + conservative_donor + cnty_pct_evangelical + contbrel_1 + single + apparel_1, family = binomial, data = within(mytrain.na, rm("density_urban")))
stepwise_deviance_selector(within(mytrain.na, rm("density_urban")), c("combined_ethnicity_4way", "density_rural", "sex", "interest_in_religion", "liberal_donor", "guns_1", "density_suburban", "conservative_donor", "cnty_pct_evangelical", "contbrel_1", "single", "apparel_1"))
model13 = glm(formula = suppdem ~ combined_ethnicity_4way + density_rural + sex + interest_in_religion + liberal_donor + guns_1 + density_suburban + conservative_donor + cnty_pct_evangelical + contbrel_1 + single + apparel_1 + education, family = binomial, data = within(mytrain.na, rm("density_urban")))
stepwise_deviance_selector(within(mytrain.na, rm("density_urban")), c("combined_ethnicity_4way", "density_rural", "sex", "interest_in_religion", "liberal_donor", "guns_1", "density_suburban", "conservative_donor", "cnty_pct_evangelical", "contbrel_1", "single", "apparel_1", "education"))
model14 = glm(formula = suppdem ~ combined_ethnicity_4way + density_rural + sex + interest_in_religion + liberal_donor + guns_1 + density_suburban + conservative_donor + cnty_pct_evangelical + contbrel_1 + single + apparel_1 + education + cat_1, family = binomial, data = within(mytrain.na, rm("density_urban")))
stepwise_deviance_selector(within(mytrain.na, rm("density_urban")), c("combined_ethnicity_4way", "density_rural", "sex", "interest_in_religion", "liberal_donor", "guns_1", "density_suburban", "conservative_donor", "cnty_pct_evangelical", "contbrel_1", "single", "apparel_1", "education", "cat_1"))
model15 = glm(formula = suppdem ~ combined_ethnicity_4way + density_rural + sex + interest_in_religion + liberal_donor + guns_1 + density_suburban + conservative_donor + cnty_pct_evangelical + contbrel_1 + single + apparel_1 + education + cat_1 + num_children, family = binomial, data = within(mytrain.na, rm("density_urban")))
stepwise_deviance_selector(within(mytrain.na, rm("density_urban")), c("combined_ethnicity_4way", "density_rural", "sex", "interest_in_religion", "liberal_donor", "guns_1", "density_suburban", "conservative_donor", "cnty_pct_evangelical", "contbrel_1", "single", "apparel_1", "education", "cat_1", "num_children"))
anova(model00, model01, model02, model03, model04, model05, model06, model07, model08, model09.1, model10, model11, model12, model13, model14, model15, test="Chisq")
```


### Selected Model 'model15' Prediction
```{r}
preds = predict(model15, data = mytrain.na, type="response")
logLoss(mytrain.na$suppdem, preds)

test.na = na.convert.mean(test)
testpreds = predict(model15, newdata=test.na, type="response")
testpreds = setNames(data.frame(testpreds), c("suppdem"))
write.csv(testpreds, "./model15_test.csv")
```

### Step-wise deviance on basic poisson model 

### Repeat above, but log median income
```{r}
mytrain.loginc <- mytrain
mytrain.loginc$census_median_income = log(mytrain.loginc$census_median_income)
mytrain.loginc.na <- mytrain.na
mytrain.loginc.na$census_median_income = log(mytrain.loginc.na$census_median_income)

model16 = glm(formula = suppdem ~ 1, family = binomial, data = mytrain.loginc)
stepwise_deviance_selector(mytrain.loginc, c(1), log = TRUE)
model17 = glm(formula = suppdem ~ combined_ethnicity_4way, family = binomial, data = mytrain.loginc)
stepwise_deviance_selector(mytrain.loginc, c("combined_ethnicity_4way"), log = TRUE)
model18 = glm(formula = suppdem ~ combined_ethnicity_4way + density_rural, family = binomial, data = mytrain.loginc)
stepwise_deviance_selector(mytrain.loginc, c("combined_ethnicity_4way", "density_rural"), log = TRUE)
model19 = glm(formula = suppdem ~ combined_ethnicity_4way + density_rural + sex, family = binomial, data = mytrain.loginc)
stepwise_deviance_selector(mytrain.loginc, c("combined_ethnicity_4way", "density_rural", "sex"), log = TRUE)
model20 = glm(formula = suppdem ~ combined_ethnicity_4way + density_rural + sex + interest_in_religion, family = binomial, data = mytrain.loginc)
stepwise_deviance_selector(mytrain.loginc, c("combined_ethnicity_4way", "density_rural", "sex", "interest_in_religion"), log = TRUE)
model21 = glm(formula = suppdem ~ combined_ethnicity_4way + density_rural + sex + interest_in_religion + liberal_donor, family = binomial, data = mytrain.loginc)
stepwise_deviance_selector(mytrain.loginc, c("combined_ethnicity_4way", "density_rural", "sex", "interest_in_religion", "liberal_donor"), log = TRUE)
model22 = glm(formula = suppdem ~ combined_ethnicity_4way + density_rural + sex + interest_in_religion + liberal_donor + guns_1, family = binomial, data = mytrain.loginc)
stepwise_deviance_selector(mytrain.loginc, c("combined_ethnicity_4way", "density_rural", "sex", "interest_in_religion", "liberal_donor", "guns_1"), log = TRUE)
model23 = glm(formula = suppdem ~ combined_ethnicity_4way + density_rural + sex + interest_in_religion + liberal_donor + guns_1 + density_suburban, family = binomial, data = within(mytrain.loginc, rm("density_urban")))
stepwise_deviance_selector(within(mytrain.loginc, rm("density_urban")), c("combined_ethnicity_4way", "density_rural", "sex", "interest_in_religion", "liberal_donor", "guns_1", "density_suburban"), log = TRUE)
model24 = glm(formula = suppdem ~ combined_ethnicity_4way + density_rural + sex + interest_in_religion + liberal_donor + guns_1 + density_suburban + conservative_donor, family = binomial, data = within(mytrain.loginc, rm("density_urban")))
stepwise_deviance_selector(within(mytrain.loginc, rm("density_urban")), c("combined_ethnicity_4way", "density_rural", "sex", "interest_in_religion", "liberal_donor", "guns_1", "density_suburban", "conservative_donor"), log = TRUE)

model25.1 = glm(formula = suppdem ~ combined_ethnicity_4way + density_rural + sex + interest_in_religion + liberal_donor + guns_1 + density_suburban + conservative_donor + cnty_pct_evangelical, family = binomial, data = within(mytrain.loginc.na, rm("density_urban")))
model25.2 = glm(formula = suppdem ~ combined_ethnicity_4way + density_rural + sex + interest_in_religion + liberal_donor + guns_1 + density_suburban + conservative_donor + cnty_pct_evangelical + cnty_pct_evangelical.na, family = binomial, data = within(mytrain.loginc.na, rm("density_urban")))
anova(model25.1, model25.2, test="Chisq")

stepwise_deviance_selector(within(mytrain.loginc.na, rm("density_urban")), c("combined_ethnicity_4way", "density_rural", "sex", "interest_in_religion", "liberal_donor", "guns_1", "density_suburban", "conservative_donor", "cnty_pct_evangelical"), log = TRUE)
model26 = glm(formula = suppdem ~ combined_ethnicity_4way + density_rural + sex + interest_in_religion + liberal_donor + guns_1 + density_suburban + conservative_donor + cnty_pct_evangelical + contbrel_1, family = binomial, data = within(mytrain.loginc.na, rm("density_urban")))
stepwise_deviance_selector(within(mytrain.na, rm("density_urban")), c("combined_ethnicity_4way", "density_rural", "sex", "interest_in_religion", "liberal_donor", "guns_1", "density_suburban", "conservative_donor", "cnty_pct_evangelical", "contbrel_1"), log = TRUE)
model27 = glm(formula = suppdem ~ combined_ethnicity_4way + density_rural + sex + interest_in_religion + liberal_donor + guns_1 + density_suburban + conservative_donor + cnty_pct_evangelical + contbrel_1 + single, family = binomial, data = within(mytrain.loginc.na, rm("density_urban")))
stepwise_deviance_selector(within(mytrain.loginc.na, rm("density_urban")), c("combined_ethnicity_4way", "density_rural", "sex", "interest_in_religion", "liberal_donor", "guns_1", "density_suburban", "conservative_donor", "cnty_pct_evangelical", "contbrel_1", "single"))
model28 = glm(formula = suppdem ~ combined_ethnicity_4way + density_rural + sex + interest_in_religion + liberal_donor + guns_1 + density_suburban + conservative_donor + cnty_pct_evangelical + contbrel_1 + single + apparel_1, family = binomial, data = within(mytrain.loginc.na, rm("density_urban")))
stepwise_deviance_selector(within(mytrain.loginc.na, rm("density_urban")), c("combined_ethnicity_4way", "density_rural", "sex", "interest_in_religion", "liberal_donor", "guns_1", "density_suburban", "conservative_donor", "cnty_pct_evangelical", "contbrel_1", "single", "apparel_1"))
model29 = glm(formula = suppdem ~ combined_ethnicity_4way + density_rural + sex + interest_in_religion + liberal_donor + guns_1 + density_suburban + conservative_donor + cnty_pct_evangelical + contbrel_1 + single + apparel_1 + education, family = binomial, data = within(mytrain.loginc.na, rm("density_urban")))
stepwise_deviance_selector(within(mytrain.loginc.na, rm("density_urban")), c("combined_ethnicity_4way", "density_rural", "sex", "interest_in_religion", "liberal_donor", "guns_1", "density_suburban", "conservative_donor", "cnty_pct_evangelical", "contbrel_1", "single", "apparel_1", "education"))
model30 = glm(formula = suppdem ~ combined_ethnicity_4way + density_rural + sex + interest_in_religion + liberal_donor + guns_1 + density_suburban + conservative_donor + cnty_pct_evangelical + contbrel_1 + single + apparel_1 + education + cat_1, family = binomial, data = within(mytrain.loginc.na, rm("density_urban")))
stepwise_deviance_selector(within(mytrain.loginc.na, rm("density_urban")), c("combined_ethnicity_4way", "density_rural", "sex", "interest_in_religion", "liberal_donor", "guns_1", "density_suburban", "conservative_donor", "cnty_pct_evangelical", "contbrel_1", "single", "apparel_1", "education", "cat_1"))
model31 = glm(formula = suppdem ~ combined_ethnicity_4way + density_rural + sex + interest_in_religion + liberal_donor + guns_1 + density_suburban + conservative_donor + cnty_pct_evangelical + contbrel_1 + single + apparel_1 + education + cat_1 + num_children, family = binomial, data = within(mytrain.loginc.na, rm("density_urban")))
stepwise_deviance_selector(within(mytrain.loginc.na, rm("density_urban")), c("combined_ethnicity_4way", "density_rural", "sex", "interest_in_religion", "liberal_donor", "guns_1", "density_suburban", "conservative_donor", "cnty_pct_evangelical", "contbrel_1", "single", "apparel_1", "education", "cat_1", "num_children"))
# it's the same thing
anova(model16, model17, model18, model19, model20, model21, model22, model16, model16, model16, model16, model16, model16, model16, model16, model16, model16, model16, model31, test="Chisq")
anova(model15, model31, test="Chisq")
```
### Testing out some interactions
hmmm.......
```{r}
model32 = glm(formula = suppdem ~ combined_ethnicity_4way + density_rural + sex + interest_in_religion + liberal_donor + guns_1 + density_suburban + conservative_donor + cnty_pct_evangelical + contbrel_1 + single + apparel_1 + education + cat_1 + num_children + education:log(census_median_income), family = binomial, data = within(mytrain.loginc.na, rm("density_urban")))
anova(model15, model32, test="Chisq")
```
### Step-wise deviance with higher alpha


### Step-wise deviance on basic probit & logit model (binomial fam)
 Perhaps we should improve our stepwise_deviance_selector to do the loop exhaustively until it reaches insignificance

### Testing
### Step-wise Deviance
### Fitting various models
### Data Imputer


## Predictions
### Results and Conclusions
### Log-loss 



### MIDPOINT STUFF: REMOVE THIS CHUNK
```{r}
stepwise_deviance_selector(within(mytrain, rm("density_urban")), c("combined_ethnicity_4way", "density_rural", "sex", "interest_in_religion", "liberal_donor", "guns_1", "density_suburban", "conservative_donor", "cnty_pct_evangelical"))


midpoint_model= glm(formula = suppdem ~ combined_ethnicity_4way + density_rural + sex + interest_in_religion + liberal_donor + guns_1 + density_suburban + conservative_donor + cnty_pct_evangelical + cnty_pct_evangelical.na,
            family = binomial, data = mytrain.na)
preds = predict(midpoint_model, data=mytrain.na, type="response")
logLoss(mytrain.na$suppdem, preds)

# Midpoint model on test data
myval.na = na.convert.mean(myvalidate)
predsval = predict(midpoint_model, data=myval.na, type="response")
logLoss(myval.na$suppdem, predsval)

test.na = na.convert.mean(test)
testpreds = predict(midpoint_model, newdata=test.na, type="response")
testpreds = setNames(data.frame(testpreds), c("suppdem"))
write.csv(testpreds, "./midpoint_model_test.csv")
```